
```
{

  "simulation_info": {

    "date": "2026-01-31 10:46:24",

    "model_version": "V4 (NASA实测参数版)",

    "output_directory": "e:\\python\\pythonProject2\\anything\\26美赛\\simulation_results"

  },

  "data_sources": {

    "OCV_model": {

      "source": "NASA B0005 第一次放电循环",

      "method": "组合模型拟合 (多项式+对数+指数)",

      "RMSE_V": 0.00113,

      "formula": "V = a + b*s + c*s² + d*s³ + e*ln(s) + f*ln(1-s) + g*exp(-30s)"

    },

    "internal_resistance": {

      "source": "NASA B0005 阻抗数据 (24°C)",

      "Re_mOhm": 46.33,

      "Rct_mOhm": 70.15,

      "R_total_mOhm": 116.48,

      "R_ref_used_mOhm": 80.0,

      "note": "R_ref已针对手机电池优化调整"

    },

    "activation_energy": {

      "source": "NASA B0005 (24°C) vs B0041 (4°C) Arrhenius分析",

      "Ea_J_mol": 26450.0,

      "Ea_kJ_mol": 26.45,

      "temperature_range_C": [

        -10,

        35

      ]

    }

  },

  "model_parameters": {

    "physics": {

      "Rg": 8.314,

      "Ea": 26450.0,

      "cp": 1040.0,

      "h": 8.0,

      "T_env_default": 25.0,

      "T_ref": 297.15,

      "E_aging": 45000.0

    },

    "device_specs": {

      "C_nom_mAh": 3200.0,

      "mass": 0.044,

      "area": 0.0105,

      "V_min": 3.0,

      "V_max": 4.47

    },

    "fitted_params": {

      "R_ref_Ohm": 0.08,

      "beta_pol": 0.01,

      "k_soc": 1.6

    },

    "ocv_params": {

      "a": 4.06604823,

      "b": -1.52460086,

      "c": 1.91129899,

      "d": -0.68008487,

      "e": 0.25735421,

      "f": -0.04142781,

      "g": -0.12824626

    },

    "power_params": {

      "P_base_W": 0.05,

      "k_scr": 3.2,

      "k_cpu": 3.5,

      "T_crit_K": 318.15

    }

  },

  "scenarios": {

    "Case_A": {

      "config": {

        "name": "办公场景 (Case A)",

        "description": "低亮度(25%)、低负载(25%)、WiFi、室温25°C",

        "brightness_L": 0.25,

        "cpu_load_alpha": 0.25,

        "gps_on": false,

        "network_mode": "WiFi",

        "ambient_temp_C": 25.0

      },

      "results": {

        "time_to_empty_h": 12.0,

        "max_temp_C": 25.4,

        "min_temp_C": 25.0,

        "final_soc_pct": 11.1,

        "final_soh": 0.999897,

        "avg_current_A": 0.36,

        "min_voltage_V": 3.0,

        "shutdown_reason": "端电压过低 (<3.0V)",

        "collapse": false

      },

      "time_series_stats": {

        "total_time_points": 23120,

        "time_span_s": 43204.46507688991,

        "time_span_h": 12.001240299136086,

        "SOC": {

          "initial": 1.0,

          "final": 0.11068112933165583,

          "min": 0.11068112933165583,

          "max": 1.0,

          "delta": 0.8893188706683441

        },

        "temperature_K": {

          "initial": 298.15,

          "final": 298.5815291484158,

          "min": 298.15,

          "max": 298.5815291484158,

          "mean": 298.2764579786675,

          "std": 0.07420306541022216

        },

        "temperature_C": {

          "initial": 25.0,

          "final": 25.431529148415848,

          "min": 25.0,

          "max": 25.431529148415848,

          "mean": 25.12645797866753

        },

        "current_A": {

          "min": 0.16327648857115276,

          "max": 0.8554587824842423,

          "mean": 0.3601167824914419,

          "std": 0.2436631201960187

        },

        "terminal_voltage_V": {

          "initial": 4.101219087546175,

          "final": 2.9999999999999893,

          "min": 2.9999999999999893,

          "max": 4.101255757048264,

          "mean": 3.536476937281245

        }

      },

      "key_events": {

        "SOC_80_percent_time_h": 2.877134094518639,

        "SOC_50_percent_time_h": 6.97890950270945,

        "SOC_20_percent_time_h": 10.890420770233456,

        "voltage_below_3_2V_time_h": 11.383340919536034,

        "voltage_below_3_0V_time_h": 12.001240299136086

      }

    },

    "Case_B": {

      "config": {

        "name": "游戏场景 (Case B)",

        "description": "高亮度(90%)、高负载(95%)、4G、高温35°C",

        "brightness_L": 0.9,

        "cpu_load_alpha": 0.95,

        "gps_on": false,

        "network_mode": "4G",

        "ambient_temp_C": 35.0

      },

      "results": {

        "time_to_empty_h": 1.67,

        "max_temp_C": 39.5,

        "min_temp_C": 35.0,

        "final_soc_pct": 18.5,

        "final_soh": 0.999808,

        "avg_current_A": 1.692,

        "min_voltage_V": 2.985,

        "shutdown_reason": "端电压过低 (<3.0V)",

        "collapse": false

      },

      "time_series_stats": {

        "total_time_points": 3304,

        "time_span_s": 6000.000000000002,

        "time_span_h": 1.6666666666666672,

        "SOC": {

          "initial": 1.0,

          "final": 0.18520848766026649,

          "min": 0.18520848766026649,

          "max": 1.0,

          "delta": 0.8147915123397336

        },

        "temperature_K": {

          "initial": 308.15,

          "final": 312.6245418422277,

          "min": 308.15,

          "max": 312.6245418422277,

          "mean": 310.43728270141514,

          "std": 0.9020528725595858

        },

        "temperature_C": {

          "initial": 35.0,

          "final": 39.47454184222772,

          "min": 35.0,

          "max": 39.47454184222772,

          "mean": 37.287282701415165

        },

        "current_A": {

          "min": 1.4201560993822553,

          "max": 2.2359596604381085,

          "mean": 1.6923965211434349,

          "std": 0.25900112471151954

        },

        "terminal_voltage_V": {

          "initial": 4.035486000655936,

          "final": 2.9851069134531585,

          "min": 2.9851069134531585,

          "max": 4.035510754239402,

          "mean": 3.4519248284541004

        }

      },

      "key_events": {

        "SOC_80_percent_time_h": 0.42491374347175925,

        "SOC_50_percent_time_h": 1.0396137899922813,

        "SOC_20_percent_time_h": 1.6367797080942559,

        "voltage_below_3_2V_time_h": 1.4666689788160192,

        "voltage_below_3_0V_time_h": 1.6666666666666672

      }

    },

    "Case_C": {

      "config": {

        "name": "极寒场景 (Case C)",

        "description": "中亮度(50%)、中负载(40%)、5G+GPS、低温-10°C",

        "brightness_L": 0.5,

        "cpu_load_alpha": 0.4,

        "gps_on": true,

        "network_mode": "5G",

        "ambient_temp_C": -10.0

      },

      "results": {

        "time_to_empty_h": 3.9,

        "max_temp_C": -8.3,

        "min_temp_C": -10.0,

        "final_soc_pct": 31.7,

        "final_soh": 0.999206,

        "avg_current_A": 0.66,

        "min_voltage_V": 2.997,

        "shutdown_reason": "端电压过低 (<3.0V)",

        "collapse": false

      },

      "time_series_stats": {

        "total_time_points": 11909,

        "time_span_s": 14040.000000000002,

        "time_span_h": 3.9000000000000004,

        "SOC": {

          "initial": 1.0,

          "final": 0.31693104725492816,

          "min": 0.31693104725492816,

          "max": 1.0,

          "delta": 0.6830689527450718

        },

        "temperature_K": {

          "initial": 263.15,

          "final": 264.79793881652756,

          "min": 263.15,

          "max": 264.84544688915565,

          "mean": 264.4893003973251,

          "std": 0.2477200706093524

        },

        "temperature_C": {

          "initial": -10.0,

          "final": -8.352061183472415,

          "min": -10.0,

          "max": -8.304553110844324,

          "mean": -8.660699602674867

        },

        "current_A": {

          "min": 0.4009311394030405,

          "max": 1.3348661728839548,

          "mean": 0.6597033391726528,

          "std": 0.2821121385563084

        },

        "terminal_voltage_V": {

          "initial": 3.8173061788255067,

          "final": 2.9974321179763788,

          "min": 2.9974321179763788,

          "max": 3.9363316895730103,

          "mean": 3.4310108740874443

        }

      },

      "key_events": {

        "SOC_80_percent_time_h": 1.203108323768771,

        "SOC_50_percent_time_h": 2.9049649809826374,

        "SOC_20_percent_time_h": null,

        "voltage_below_3_2V_time_h": 2.366675882053265,

        "voltage_below_3_0V_time_h": 3.9000000000000004

      }

    },

    "Case_D": {

      "config": {

        "name": "低温轻度 (Case D)",

        "description": "低亮度(20%)、低负载(20%)、WiFi、低温0°C",

        "brightness_L": 0.2,

        "cpu_load_alpha": 0.2,

        "gps_on": false,

        "network_mode": "WiFi",

        "ambient_temp_C": 0.0

      },

      "results": {

        "time_to_empty_h": 14.22,

        "max_temp_C": 0.4,

        "min_temp_C": 0.0,

        "final_soc_pct": 12.6,

        "final_soh": 0.999476,

        "avg_current_A": 0.323,

        "min_voltage_V": 2.994,

        "shutdown_reason": "端电压过低 (<3.0V)",

        "collapse": false

      },

      "time_series_stats": {

        "total_time_points": 27343,

        "time_span_s": 51180.0,

        "time_span_h": 14.216666666666667,

        "SOC": {

          "initial": 1.0,

          "final": 0.1255775789904433,

          "min": 0.1255775789904433,

          "max": 1.0,

          "delta": 0.8744224210095567

        },

        "temperature_K": {

          "initial": 273.15,

          "final": 273.53654363456246,

          "min": 273.15,

          "max": 273.56126935719357,

          "mean": 273.3369662075124,

          "std": 0.06049999426007891

        },

        "temperature_C": {

          "initial": 0.0,

          "final": 0.38654363456248575,

          "min": 0.0,

          "max": 0.41126935719358926,

          "mean": 0.18696620751239834

        },

        "current_A": {

          "min": 0.12792927331961118,

          "max": 0.7963099471061367,

          "mean": 0.3226658095993943,

          "std": 0.2496716555693542

        },

        "terminal_voltage_V": {

          "initial": 4.029258172479442,

          "final": 2.9943631982201304,

          "min": 2.9943631982201304,

          "max": 4.086208676796836,

          "mean": 3.5093732151994272

        }

      },

      "key_events": {

        "SOC_80_percent_time_h": 3.4670239242879823,

        "SOC_50_percent_time_h": 8.406094310235845,

        "SOC_20_percent_time_h": 13.100322130914783,

        "voltage_below_3_2V_time_h": 12.850020311214596,

        "voltage_below_3_0V_time_h": 14.216666666666667

      }

    }

  },

  "figures": {

    "ocv_model_comparison": {

      "path": "e:\\python\\pythonProject2\\anything\\26美赛\\simulation_results\\ocv_model_comparison.png",

      "description": "V3 vs V4 OCV模型对比，展示非线性模型在低SOC区域的改进",

      "subplots": [

        "全范围对比",

        "低SOC区域放大 (SOC<25%)"

      ]

    },

    "Case_A_detailed": {

      "path": "e:\\python\\pythonProject2\\anything\\26美赛\\simulation_results\\Case_A_detailed_v4.png",

      "description": "办公场景 (Case A) 详细仿真结果",

      "subplots": [

        "SOC随时间变化",

        "端电压随时间变化",

        "温度随时间变化",

        "电流随时间变化"

      ]

    },

    "Case_B_detailed": {

      "path": "e:\\python\\pythonProject2\\anything\\26美赛\\simulation_results\\Case_B_detailed_v4.png",

      "description": "游戏场景 (Case B) 详细仿真结果",

      "subplots": [

        "SOC随时间变化",

        "端电压随时间变化",

        "温度随时间变化",

        "电流随时间变化"

      ]

    },

    "Case_C_detailed": {

      "path": "e:\\python\\pythonProject2\\anything\\26美赛\\simulation_results\\Case_C_detailed_v4.png",

      "description": "极寒场景 (Case C) 详细仿真结果",

      "subplots": [

        "SOC随时间变化",

        "端电压随时间变化",

        "温度随时间变化",

        "电流随时间变化"

      ]

    },

    "Case_D_detailed": {

      "path": "e:\\python\\pythonProject2\\anything\\26美赛\\simulation_results\\Case_D_detailed_v4.png",

      "description": "低温轻度 (Case D) 详细仿真结果",

      "subplots": [

        "SOC随时间变化",

        "端电压随时间变化",

        "温度随时间变化",

        "电流随时间变化"

      ]

    },

    "scenario_comparison": {

      "path": "e:\\python\\pythonProject2\\anything\\26美赛\\simulation_results\\scenario_comparison_v4.png",

      "description": "多场景对比图，展示不同使用条件下的电池行为差异",

      "subplots": [

        "SOC放电曲线对比",

        "端电压曲线对比",

        "电池温度曲线对比"

      ],

      "key_insight": "观察Case_C(极寒)在SOC较高时因电压过低提前关机"

    }

  },

  "comparison_analysis": {

    "best_battery_life": "Case_D",

    "worst_battery_life": "Case_B",

    "highest_remaining_soc_at_shutdown": "Case_C",

    "lowest_voltage_observed": "Case_B",

    "physical_phenomena": {

      "low_temp_early_shutdown": {

        "description": "低温导致内阻增大，电池在SOC较高时因端电压过低提前关机",

        "observed_in": "Case_C",

        "remaining_soc_pct": 31.7

      },

      "high_load_voltage_drop": {

        "description": "高负载场景电流大，内阻压降大，导致端电压快速下降",

        "observed_in": "Case_B"

      },

      "nonlinear_soc_drop": {

        "description": "非线性OCV模型使SOC曲线末端出现加速下降特征",

        "model_feature": "ln(SOC)项捕捉低电量跳水现象"

      }

    }

  }

}
```


```
"""

================================================================================

智能手机电池寿命仿真模型 V4 (NASA实测参数版)

================================================================================

功能说明：

    本代码实现了一个耦合 SOC（荷电状态）、温度、SOH（健康状态）的连续时间动态系统，

    用于模拟智能手机电池在不同使用场景下的放电行为。

  

V4 版本核心改进：

    1. 基于 NASA B0005/B0041 数据集的实测参数

    2. 非线性 OCV 模型 (多项式 + 对数 + 指数)，精确捕捉低电量"跳水"

    3. Arrhenius 活化能来自实测 (Ea = 26.45 kJ/mol)

    4. 新增端电压截止事件，模拟低温强制关机

  

物理现象捕捉：

    - 低温续航跳水：Arrhenius 内阻模型

    - 低电量突然关机：非线性 OCV + 端电压截止

    - 热节流降频：Sigmoid 节流函数

  

数据来源：

    - OCV 参数：NASA B0005 第一次放电循环拟合 (RMSE=1.13mV)

    - 内阻/活化能：B0005 (24°C) + B0041 (4°C) 阻抗数据

  

作者：AI Assistant

日期：2026年1月31日

================================================================================

"""

  

from __future__ import annotations

  

import os

import json

from dataclasses import dataclass, field

from typing import Callable, Dict, Tuple, List, Any

from datetime import datetime

  

import numpy as np

from scipy.integrate import solve_ivp

from scipy.interpolate import interp1d

import matplotlib.pyplot as plt

from matplotlib import font_manager

  

# ================================================================================

# 第一部分：全局配置区 (基于 NASA 实测数据)

# ================================================================================

# 数据来源：

#   - OCV: NASA B0005 放电曲线拟合 (组合模型 RMSE=0.00113V)

#   - 内阻: B0005 (24°C) Re+Rct = 116.48 mΩ

#   - 活化能: B0005 vs B0041 Arrhenius 分析 Ea = 26450 J/mol

# ================================================================================

  

BATTERY_CONFIG = {

    # ------------------------------------------------------------------------

    # 物理常数与环境参数

    # ------------------------------------------------------------------------

    "physics": {

        "Rg": 8.314,           # 理想气体常数 [J/(mol·K)]

        "Ea": 26450.0,         # [实测] 活化能 26.45 kJ/mol (NASA B0005 vs B0041)

        "cp": 1040.0,          # 电池比热容 [J/(kg·K)]

        "h": 8.0,              # 对流换热系数 [W/(m²·K)]

        "T_env_default": 25.0, # 默认环境温度 [°C]

        "T_ref": 297.15,       # [实测] 参考温度 24°C = 297.15K (对应 B0005)

        "E_aging": 45000.0,    # 老化活化能 [J/mol]

    },

  

    # ------------------------------------------------------------------------

    # 设备规格参数 (iPhone 14 Pro 参考)

    # ------------------------------------------------------------------------

    "device_specs": {

        "C_nom_mAh": 3200.0,   # 额定容量 [mAh]

        "mass": 0.044,         # 电池质量 [kg]

        "area": 0.0105,        # 有效散热面积 [m²]

        "V_min": 3.0,          # 截止电压 [V]

        "V_max": 4.47,         # 满充电压 [V]

    },

  

    # ------------------------------------------------------------------------

    # 电池模型拟合参数 (基于 NASA 实测)

    # ------------------------------------------------------------------------

    "fitted_params": {

        "R_ref": 0.080,        # [调整] 参考内阻 80 mΩ @ 24°C (考虑手机电池优化)

        "beta_pol": 0.010,     # [调整] 极化内阻系数 (减小)

        "k_ref": 1.0e-8,       # 老化速率参考值

        "T_opt": 298.15,       # 最佳工作温度 [K]

        "k_soc": 1.6,          # SOC 极化指数

        "eps": 1e-4,           # 数值保护常数

  

        # ====================================================================

        # [核心] 非线性 OCV 模型参数 (NASA B0005 拟合)

        # ====================================================================

        # 公式: V = a + b*s + c*s² + d*s³ + e*ln(s) + f*ln(1-s) + g*exp(-30s)

        #

        # 物理意义：

        #   - 多项式项 (a,b,c,d): 描述中间段平缓下降

        #   - ln(s) 项 (e): 捕捉低 SOC 时的电压"跳水"

        #   - ln(1-s) 项 (f): 捕捉高 SOC 时的饱和行为

        #   - exp(-30s) 项 (g): 修正极低 SOC 时的非线性

        # ====================================================================

        "ocv_params": {

            "a": 4.06604823,

            "b": -1.52460086,

            "c": 1.91129899,

            "d": -0.68008487,

            "e": 0.25735421,   # ln(SOC) 项：低电量跳水的关键

            "f": -0.04142781,  # ln(1-SOC) 项：高电量饱和

            "g": -0.12824626,  # exp(-30*SOC) 项：极低电量修正

        },

    },

  

    # ------------------------------------------------------------------------

    # 功耗模型参数 (A16 Bionic + LTPO Screen)

    # ------------------------------------------------------------------------

    "power_params": {

        # 基础与屏幕

        "P_base": 0.05,        # 系统底噪 50mW

        "P_panel_base": 0.1,   # 屏幕基础电路功耗 [W]

        "k_scr": 3.2,          # 屏幕亮度系数

        "beta_screen": 1.6,    # 亮度非线性指数 (OLED 特性)

  

        # 处理器 (A16)

        "P_leak_ref": 0.05,    # CPU 静态漏电 [W]

        "lambda_leak": 0.015,  # 漏电温度系数 [1/K]

        "k_cpu": 3.5,          # 处理器功耗系数

        "T_crit": 318.15,      # 热节流温度 45°C [K]

        "k_th": 0.3,           # 热节流响应斜率

  

        # 网络通信

        "P_idle": 0.01,        # 网络空闲功耗 [W]

        "k_net": 0.1,          # 平均发射功率 [W]

        "lambda_snr": 0.35,    # 信号衰减因子

  

        # 脉冲任务配置

        "P_wake": 0.3,         # 后台唤醒功耗 [W]

        "N_app": 6,            # 后台 App 数量

        "bg_period": 60.0,     # 后台周期 [s]

        "bg_on": 5.0,          # 后台活跃时长 [s]

        "P_gps": 0.5,          # GPS 功耗 [W]

        "gps_period": 30.0,    # GPS 周期 [s]

        "gps_on": 10.0,        # GPS 活跃时长 [s]

  

        # 网络制式倍率

        "M_tech_factors": {

            "4G": 1.0,

            "5G": 1.4,

            "WiFi": 0.8,

        },

    },

  

    # ------------------------------------------------------------------------

    # [废弃] 旧版简单多项式 OCV 系数 (保留兼容性)

    # ------------------------------------------------------------------------

    "ocv_coeffs_legacy": [0.6, -0.4, 0.87, 3.4],

  

    # ------------------------------------------------------------------------

    # 随机信号参数 (OU 过程)

    # ------------------------------------------------------------------------

    "ou_params": {

        "mu": 0.0,

        "theta": 0.2,

        "sigma": 0.5,

    },

}

  

# ================================================================================

# 第二部分：场景配置

# ================================================================================

  

SCENARIO_PROFILES: Dict[str, Dict[str, Any]] = {

    # ------------------------------------------------------------------------

    # Case A：办公场景 (低功耗基准)

    # ------------------------------------------------------------------------

    "case_a": {

        "name": "办公场景 (Case A)",

        "description": "低亮度(25%)、低负载(25%)、WiFi、室温25°C",

        "L": 0.25,

        "alpha": 0.25,

        "gps_on": False,

        "net_mode": "WiFi",

        "T_env_C": 25.0,

    },

  

    # ------------------------------------------------------------------------

    # Case B：游戏场景 (高功耗高温)

    # ------------------------------------------------------------------------

    "case_b": {

        "name": "游戏场景 (Case B)",

        "description": "高亮度(90%)、高负载(95%)、4G、高温35°C",

        "L": 0.9,

        "alpha": 0.95,

        "gps_on": False,

        "net_mode": "4G",

        "T_env_C": 35.0,

    },

  

    # ------------------------------------------------------------------------

    # Case C：极寒户外场景 (低温关机测试)

    # ------------------------------------------------------------------------

    "case_c": {

        "name": "极寒场景 (Case C)",

        "description": "中亮度(50%)、中负载(40%)、5G+GPS、低温-10°C",

        "L": 0.5,

        "alpha": 0.4,

        "gps_on": True,

        "net_mode": "5G",

        "T_env_C": -10.0,

    },

    # ------------------------------------------------------------------------

    # Case D：低温轻度使用 (对照组)

    # ------------------------------------------------------------------------

    "case_d": {

        "name": "低温轻度 (Case D)",

        "description": "低亮度(20%)、低负载(20%)、WiFi、低温0°C",

        "L": 0.2,

        "alpha": 0.2,

        "gps_on": False,

        "net_mode": "WiFi",

        "T_env_C": 0.0,

    },

}

  

# ================================================================================

# 第三部分：工具函数

# ================================================================================

  

def get_output_dir() -> str:

    """获取输出目录路径，若不存在则创建。"""

    script_dir = os.path.dirname(os.path.abspath(__file__))

    output_dir = os.path.join(script_dir, "simulation_results")

    os.makedirs(output_dir, exist_ok=True)

    return output_dir

  
  

def configure_chinese_font() -> None:

    """配置 matplotlib 中文字体。"""

    script_dir = os.path.dirname(os.path.abspath(__file__))

    font_path = os.path.join(script_dir, "..", "fonts", "msyh.ttc")

    font_path = os.path.abspath(font_path)

  

    if os.path.exists(font_path):

        font_manager.fontManager.addfont(font_path)

        font_prop = font_manager.FontProperties(fname=font_path)

        plt.rcParams["font.family"] = font_prop.get_name()

    else:

        plt.rcParams["font.family"] = ["Microsoft YaHei", "SimHei", "sans-serif"]

  

    plt.rcParams["axes.unicode_minus"] = False

  
  

def generate_ou_process(

    t_end: float,

    dt: float = 1.0,

    mu: float = 0.0,

    theta: float = 0.15,

    sigma: float = 0.3,

    seed: int | None = 42,

) -> Tuple[np.ndarray, interp1d]:

    """

    生成 Ornstein-Uhlenbeck (OU) 随机过程。

  

    数学公式：dγ(t) = θ(μ - γ(t))dt + σdW(t)

  

    用于模拟信号强度的随机波动。

    """

    rng = np.random.default_rng(seed)

    t = np.arange(0.0, t_end + dt, dt)

    gamma = np.zeros_like(t)

  

    for i in range(1, len(t)):

        dW = rng.normal(0.0, np.sqrt(dt))

        gamma[i] = gamma[i - 1] + theta * (mu - gamma[i - 1]) * dt + sigma * dW

  

    gamma_func = interp1d(t, gamma, kind="linear", fill_value="extrapolate")

    return t, gamma_func

  
  

def get_scenario_activity(scenario_key: str) -> Dict[str, Any]:

    """根据场景键获取用户活动配置。"""

    if scenario_key in SCENARIO_PROFILES:

        return SCENARIO_PROFILES[scenario_key].copy()

    else:

        return {

            "name": "默认场景",

            "description": "中等亮度、中等负载、4G、室温",

            "L": 0.5,

            "alpha": 0.5,

            "gps_on": False,

            "net_mode": "4G",

            "T_env_C": 25.0,

        }

  
  

# ================================================================================

# 第四部分：电池系统类

# ================================================================================

  

@dataclass

class BatterySystem:

    """

    电池系统仿真类 (V4 - NASA实测参数版)

  

    状态变量：y = [SOC, T, SOH]

        - SOC: 荷电状态 (0~1)

        - T: 温度 [K]

        - SOH: 健康状态 (0~1)

    """

    config: Dict[str, Any]

    gamma_func: Callable[[float], float]

    scenario_key: str

    collapse: bool = field(default=False, init=False)

    shutdown_reason: str = field(default="", init=False)

  

    def __post_init__(self) -> None:

        """初始化后处理：解包参数并进行单位转换。"""

        self.physics = self.config["physics"]

        self.device_specs = self.config["device_specs"]

        self.fitted = self.config["fitted_params"]

        self.power = self.config["power_params"]

        self.ocv_params = self.fitted["ocv_params"]

  

        self.activity = get_scenario_activity(self.scenario_key)

  

        # 容量：mAh → 库仑 (C)

        self.C_nom_C = self.device_specs["C_nom_mAh"] * 3.6

  

        # 温度：摄氏度 → 开尔文

        self.T_env = self.activity["T_env_C"] + 273.15

  

        # 缓存常用物理参数

        self.Rg = self.physics["Rg"]

        self.Ea = self.physics["Ea"]

        self.cp = self.physics["cp"]

        self.h = self.physics["h"]

        self.T_ref = self.physics["T_ref"]

        self.E_aging = self.physics["E_aging"]

        self.mass = self.device_specs["mass"]

        self.area = self.device_specs["area"]

        self.V_min = self.device_specs["V_min"]

  

    # ============================================================

    # 电池物理子模块

    # ============================================================

  

    def ocv(self, soc: float) -> float:

        """

        计算开路电压 (混合物理模型 - NASA B0005 拟合)。

  

        数学公式：

            V_oc = a + b*s + c*s² + d*s³ + e*ln(s) + f*ln(1-s) + g*exp(-30s)

  

        物理意义：

            - 多项式项 (a,b,c,d): 中间段平缓变化

            - ln(s) 项 (e): 低 SOC 时电压"跳水" (电化学极化)

            - ln(1-s) 项 (f): 高 SOC 时饱和行为

            - exp(-30s) 项 (g): 极低 SOC 非线性修正

  

        参数：

            soc: 荷电状态 (0~1)

  

        返回：

            开路电压 [V]

        """

        # 确保 soc 是标量

        soc_val = float(soc) if hasattr(soc, '__float__') else float(soc)

        # 数值保护：防止 ln(0) 和 ln(负数)

        s = max(min(soc_val, 1.0 - 1e-4), 1e-4)

        p = self.ocv_params

  

        # 计算各分项

        term_poly = p['a'] + p['b'] * s + p['c'] * (s ** 2) + p['d'] * (s ** 3)

        term_log_low = p['e'] * np.log(s)        # 低电量跳水

        term_log_high = p['f'] * np.log(1 - s)   # 满电饱和

        term_exp = p['g'] * np.exp(-30 * s)      # 极低电量修正

  

        v_oc = term_poly + term_log_low + term_log_high + term_exp

        return float(v_oc)

  

    def r_total(self, T: float, soc: float) -> float:

        """

        计算电池总内阻 (Arrhenius + 极化模型)。

  

        数学公式：

            R_total = R_arr + R_pol

            R_arr = R_ref × exp(Ea/Rg × (1/T - 1/T_ref))  # Arrhenius 温度依赖

            R_pol = β_pol / (SOC^k + ε)                    # SOC 极化依赖

  

        参数说明：

            - Ea = 26450 J/mol (NASA 实测)

            - R_ref = 80 mΩ @ 24°C

            - T_ref = 297.15 K (24°C)

  

        返回：

            总内阻 [Ω]

        """

        # 确保输入是标量

        T_val = float(T)

        soc_val = float(soc) if hasattr(soc, '__float__') else float(soc)

        soc_clip = max(min(soc_val, 1.0), 1e-6)

  

        # Arrhenius 项：温度依赖

        R_arr = self.fitted["R_ref"] * np.exp(

            (self.Ea / self.Rg) * (1.0 / T_val - 1.0 / self.T_ref)

        )

  

        # 极化项：SOC 依赖

        R_pol = self.fitted["beta_pol"] / (

            soc_clip ** self.fitted["k_soc"] + self.fitted["eps"]

        )

  

        # 内阻钳位：模拟电池保护板物理限制

        R_total = R_arr + R_pol

        R_max = 3.0  # 最大允许内阻 [Ω]

        return float(min(R_total, R_max))

  

    def k_aging(self, T: float) -> float:

        """

        计算老化速率系数 (V 形曲线)。

  

        公式：K_aging = k_ref × exp(E_aging/Rg × |1/T - 1/T_opt|)

        """

        return float(

            self.fitted["k_ref"]

            * np.exp(

                (self.E_aging / self.Rg)

                * abs(1.0 / T - 1.0 / self.fitted["T_opt"])

            )

        )

  

    # ============================================================

    # 功耗子模块

    # ============================================================

  

    def eta_throttle(self, T: float) -> float:

        """

        计算热节流效率因子。

  

        公式：η_throttle = 1 / (1 + exp(k_th × (T - T_crit)))

        """

        return float(

            1.0 / (1.0 + np.exp(self.power["k_th"] * (T - self.power["T_crit"])))

        )

  

    def power_total(self, t: float, T: float) -> float:

        """

        计算当前时刻的总功耗。

  

        功耗组成：P_total = P_cpu + P_screen + P_net + P_bg + P_gps + P_base

        """

        L = self.activity["L"]

        alpha = self.activity["alpha"]

        gps_on = self.activity["gps_on"]

        net_mode = self.activity["net_mode"]

  

        # CPU 功耗

        eta = self.eta_throttle(T)

        effective_load = alpha * eta

        P_leak = self.power["P_leak_ref"] * (

            1.0 + self.power["lambda_leak"] * (T - self.T_ref)

        )

        P_dynamic = self.power["k_cpu"] * (effective_load ** 3)

        P_cpu = P_leak + P_dynamic

  

        # 屏幕功耗

        delta_on = 1.0 if L > 1e-6 else 0.0

        P_screen = delta_on * (

            self.power["P_panel_base"]

            + self.power["k_scr"] * (L ** self.power["beta_screen"])

        )

  

        # 网络功耗

        gamma_t = float(self.gamma_func(t))

        M_tech = self.power["M_tech_factors"].get(net_mode, 1.0)

        P_net = M_tech * (

            self.power["P_idle"]

            + self.power["k_net"] * np.exp(-self.power["lambda_snr"] * gamma_t)

        )

  

        # 后台任务功耗

        bg_phase = t % self.power["bg_period"]

        bg_active = 1.0 if bg_phase < self.power["bg_on"] else 0.0

        P_bg = self.power["N_app"] * self.power["P_wake"] * bg_active

  

        # GPS 功耗

        if gps_on:

            gps_phase = t % self.power["gps_period"]

            gps_active = 1.0 if gps_phase < self.power["gps_on"] else 0.0

            P_gps = self.power["P_gps"] * gps_active

        else:

            P_gps = 0.0

  

        P_total = P_cpu + P_screen + P_net + P_bg + P_gps + self.power["P_base"]

        return float(P_total)

  

    # ============================================================

    # 电流与电压求解

    # ============================================================

  

    def solve_current(self, soc: float, T: float, P_total: float) -> float:

        """

        根据功率平衡方程求解放电电流。

  

        功率平衡：P = V_term × I = (V_oc - I×R) × I

        二次方程：R×I² - V_oc×I + P = 0

        解：I = (V_oc - √(V_oc² - 4RP)) / (2R)

        """

        Voc = self.ocv(soc)

        R = self.r_total(T, soc)

  

        discriminant = Voc ** 2 - 4.0 * R * P_total

  

        if discriminant < 0.0:

            print(f"[DEBUG] 电压崩溃! SOC={soc:.4f}, T={T-273.15:.1f}°C")

            print(f"        Voc={Voc:.3f}V, R={R*1000:.1f}mΩ, P={P_total:.2f}W")

            print(f"        判别式={discriminant:.4f}")

            self.collapse = True

            self.shutdown_reason = "电压崩溃 (负载过大)"

            return 0.0

  

        I = (Voc - np.sqrt(discriminant)) / (2.0 * R)

        return float(max(I, 0.0))

  

    def get_terminal_voltage(self, soc: float, T: float, P_total: float) -> float:

        """

        计算端电压。

  

        公式：V_term = V_oc - I × R

        """

        Voc = self.ocv(soc)

        R = self.r_total(T, soc)

        discriminant = Voc ** 2 - 4.0 * R * P_total

  

        if discriminant < 0.0:

            return 0.0  # 已崩溃

  

        # 端电压 = (Voc + sqrt(delta)) / 2 或 Voc - I*R

        I = (Voc - np.sqrt(discriminant)) / (2.0 * R)

        V_term = Voc - I * R

        return float(V_term)

  

    def get_discriminant(self, soc: float, T: float, P_total: float) -> float:

        """计算电压崩溃判别式。"""

        Voc = self.ocv(soc)

        R = self.r_total(T, soc)

        return float(Voc ** 2 - 4.0 * R * P_total)

  

    # ============================================================

    # ODE 系统

    # ============================================================

  

    def model(self, t: float, y: np.ndarray) -> np.ndarray:

        """

        状态方程（ODE 右端函数）。

  

        微分方程组：

            dSOC/dt = -I / (C_nom × SOH)

            dT/dt = (I²R - hA(T-T_env)) / (mc_p)

            dSOH/dt = -K_aging × |I|

        """

        soc, T, soh = y

  

        P_total = self.power_total(t, T)

        I = self.solve_current(soc, T, P_total)

  

        if self.collapse:

            return np.array([0.0, 0.0, 0.0])

  

        # SOC 变化率

        dSOC = -I / (self.C_nom_C * max(soh, 1e-4))

  

        # 温度变化率

        R = self.r_total(T, soc)

        Q_gen = I ** 2 * R

        Q_dis = self.h * self.area * (T - self.T_env)

        dT = (Q_gen - Q_dis) / (self.mass * self.cp)

  

        # SOH 变化率

        K = self.k_aging(T)

        dSOH = -K * abs(I)

  

        return np.array([dSOC, dT, dSOH])

  

    # ============================================================

    # 事件函数

    # ============================================================

  

    def event_soc_low(self, t: float, y: np.ndarray) -> float:

        """SOC 过低终止事件 (SOC < 1%)。"""

        return y[0] - 0.01

  

    def event_voltage_collapse(self, t: float, y: np.ndarray) -> float:

        """电压崩溃终止事件 (判别式 < 0)。"""

        if self.collapse:

            return 0.0

        soc, T, _ = y

        P_total = self.power_total(t, T)

        return self.get_discriminant(soc, T, P_total)

  

    def event_voltage_low(self, t: float, y: np.ndarray) -> float:

        """

        [V4新增] 端电压截止保护事件。

  

        当电池端电压跌破 V_min (3.0V) 时触发终止。

        这是模拟手机低温/低电量强制关机的关键机制。

  

        物理意义：

            真实手机的 PMIC 会监测端电压，当电压过低时

            无法维持电路正常工作，触发强制关机。

        """

        soc, T, _ = y

        P_total = self.power_total(t, T)

        V_term = self.get_terminal_voltage(soc, T, P_total)

  

        if V_term <= 0:

            return -1.0  # 已经崩溃

  

        return V_term - self.V_min  # 设定 3.0V 为截止阈值

  
  

# ================================================================================

# 第五部分：仿真执行与结果处理

# ================================================================================

  

def run_simulation(

    scenario_key: str,

    config: Dict[str, Any] = BATTERY_CONFIG,

    t_end: float = 24 * 3600.0,

    dt_gamma: float = 1.0,

    seed: int | None = 42,

) -> Dict[str, Any]:

    """

    执行单个场景的仿真。

  

    参数：

        scenario_key: 场景标识符

        config: 配置字典

        t_end: 仿真时长 [s]

        dt_gamma: OU 过程采样步长 [s]

        seed: 随机种子

  

    返回：

        包含仿真结果的字典

    """

    # 生成 OU 过程

    ou_params = config.get("ou_params", {})

    _, gamma_func = generate_ou_process(

        t_end=t_end,

        dt=dt_gamma,

        mu=ou_params.get("mu", 0.0),

        theta=ou_params.get("theta", 0.15),

        sigma=ou_params.get("sigma", 0.3),

        seed=seed,

    )

  

    # 创建电池系统实例

    system = BatterySystem(

        config=config,

        gamma_func=gamma_func,

        scenario_key=scenario_key,

    )

  

    # 初始状态

    y0 = np.array([1.0, system.T_env, 1.0])

  

    # ========================

    # 配置事件函数

    # ========================

    def event_soc_low(t: float, y: np.ndarray) -> float:

        return system.event_soc_low(t, y)

  

    def event_voltage_collapse(t: float, y: np.ndarray) -> float:

        return system.event_voltage_collapse(t, y)

  

    def event_voltage_low(t: float, y: np.ndarray) -> float:

        return system.event_voltage_low(t, y)

  

    event_soc_low.terminal = True

    event_soc_low.direction = -1

  

    event_voltage_collapse.terminal = True

    event_voltage_collapse.direction = -1

  

    event_voltage_low.terminal = True

    event_voltage_low.direction = -1

  

    # ========================

    # 求解 ODE

    # ========================

    sol = solve_ivp(

        fun=system.model,

        t_span=(0.0, t_end),

        y0=y0,

        method="BDF",

        max_step=5.0,

        events=[event_soc_low, event_voltage_collapse, event_voltage_low],

        rtol=1e-6,

        atol=1e-8,

    )

  

    # ========================

    # 提取结果

    # ========================

    t = sol.t

    SOC = sol.y[0]

    T = sol.y[1]

    SOH = sol.y[2]

  

    # 重构电流和端电压轨迹

    I = np.zeros_like(t)

    V_term = np.zeros_like(t)

    for i in range(len(t)):

        P_total = system.power_total(t[i], T[i])

        I[i] = system.solve_current(SOC[i], T[i], P_total)

        V_term[i] = system.get_terminal_voltage(SOC[i], T[i], P_total)

  

    # 确定关机原因

    shutdown_reason = "正常放电完成"

    if system.collapse:

        shutdown_reason = system.shutdown_reason

    elif sol.t_events[0].size > 0:

        shutdown_reason = "SOC 过低 (<1%)"

    elif sol.t_events[1].size > 0:

        shutdown_reason = "电压崩溃"

    elif sol.t_events[2].size > 0:

        shutdown_reason = f"端电压过低 (<{system.V_min}V)"

  

    # 结果摘要

    time_to_empty_h = t[-1] / 3600.0

    max_temp_C = np.max(T) - 273.15

    min_temp_C = np.min(T) - 273.15

    final_soc = SOC[-1]

    final_soh = SOH[-1]

    avg_current = np.mean(I)

    min_voltage = np.min(V_term)

  

    summary = {

        "time_to_empty_h": round(time_to_empty_h, 2),

        "max_temp_C": round(max_temp_C, 1),

        "min_temp_C": round(min_temp_C, 1),

        "final_soc_pct": round(final_soc * 100, 1),

        "final_soh": round(final_soh, 6),

        "avg_current_A": round(avg_current, 3),

        "min_voltage_V": round(min_voltage, 3),

        "shutdown_reason": shutdown_reason,

        "collapse": system.collapse,

    }

  

    return {

        "sol": sol,

        "t": t,

        "SOC": SOC,

        "T": T,

        "SOH": SOH,

        "I": I,

        "V_term": V_term,

        "scenario": system.activity,

        "summary": summary,

    }

  
  

def save_results_to_json(

    all_results: Dict[str, Dict[str, Any]],

    output_dir: str,

    figure_paths: Dict[str, str] = None,

) -> str:

    """

    将仿真结果摘要保存为详细的 JSON 文件。

    包含内容：

        - 模型配置参数

        - 各场景仿真结果

        - 时序数据统计

        - 图像文件路径

    """

    # 基础信息

    summary_data = {

        "simulation_info": {

            "date": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),

            "model_version": "V4 (NASA实测参数版)",

            "output_directory": output_dir,

        },

        # 数据来源

        "data_sources": {

            "OCV_model": {

                "source": "NASA B0005 第一次放电循环",

                "method": "组合模型拟合 (多项式+对数+指数)",

                "RMSE_V": 0.00113,

                "formula": "V = a + b*s + c*s² + d*s³ + e*ln(s) + f*ln(1-s) + g*exp(-30s)",

            },

            "internal_resistance": {

                "source": "NASA B0005 阻抗数据 (24°C)",

                "Re_mOhm": 46.33,

                "Rct_mOhm": 70.15,

                "R_total_mOhm": 116.48,

                "R_ref_used_mOhm": 80.0,

                "note": "R_ref已针对手机电池优化调整",

            },

            "activation_energy": {

                "source": "NASA B0005 (24°C) vs B0041 (4°C) Arrhenius分析",

                "Ea_J_mol": 26450.0,

                "Ea_kJ_mol": 26.45,

                "temperature_range_C": [-10, 35],

            },

        },

        # 模型参数

        "model_parameters": {

            "physics": BATTERY_CONFIG["physics"],

            "device_specs": BATTERY_CONFIG["device_specs"],

            "fitted_params": {

                "R_ref_Ohm": BATTERY_CONFIG["fitted_params"]["R_ref"],

                "beta_pol": BATTERY_CONFIG["fitted_params"]["beta_pol"],

                "k_soc": BATTERY_CONFIG["fitted_params"]["k_soc"],

            },

            "ocv_params": BATTERY_CONFIG["fitted_params"]["ocv_params"],

            "power_params": {

                "P_base_W": BATTERY_CONFIG["power_params"]["P_base"],

                "k_scr": BATTERY_CONFIG["power_params"]["k_scr"],

                "k_cpu": BATTERY_CONFIG["power_params"]["k_cpu"],

                "T_crit_K": BATTERY_CONFIG["power_params"]["T_crit"],

            },

        },

        # 场景配置与结果

        "scenarios": {},

        # 图像文件

        "figures": figure_paths if figure_paths else {},

    }

  

    # 填充场景数据

    for label, result in all_results.items():

        t = result["t"]

        SOC = result["SOC"]

        T = result["T"]

        I = result["I"]

        V_term = result["V_term"]

        scenario_data = {

            # 场景配置

            "config": {

                "name": result["scenario"]["name"],

                "description": result["scenario"]["description"],

                "brightness_L": result["scenario"]["L"],

                "cpu_load_alpha": result["scenario"]["alpha"],

                "gps_on": result["scenario"]["gps_on"],

                "network_mode": result["scenario"]["net_mode"],

                "ambient_temp_C": result["scenario"]["T_env_C"],

            },

            # 主要结果

            "results": result["summary"],

            # 时序数据统计

            "time_series_stats": {

                "total_time_points": len(t),

                "time_span_s": float(t[-1] - t[0]) if len(t) > 1 else 0,

                "time_span_h": float((t[-1] - t[0]) / 3600) if len(t) > 1 else 0,

                "SOC": {

                    "initial": float(SOC[0]),

                    "final": float(SOC[-1]),

                    "min": float(np.min(SOC)),

                    "max": float(np.max(SOC)),

                    "delta": float(SOC[0] - SOC[-1]),

                },

                "temperature_K": {

                    "initial": float(T[0]),

                    "final": float(T[-1]),

                    "min": float(np.min(T)),

                    "max": float(np.max(T)),

                    "mean": float(np.mean(T)),

                    "std": float(np.std(T)),

                },

                "temperature_C": {

                    "initial": float(T[0] - 273.15),

                    "final": float(T[-1] - 273.15),

                    "min": float(np.min(T) - 273.15),

                    "max": float(np.max(T) - 273.15),

                    "mean": float(np.mean(T) - 273.15),

                },

                "current_A": {

                    "min": float(np.min(I)),

                    "max": float(np.max(I)),

                    "mean": float(np.mean(I)),

                    "std": float(np.std(I)),

                },

                "terminal_voltage_V": {

                    "initial": float(V_term[0]),

                    "final": float(V_term[-1]),

                    "min": float(np.min(V_term)),

                    "max": float(np.max(V_term)),

                    "mean": float(np.mean(V_term)),

                },

            },

            # 关键时刻

            "key_events": {

                "SOC_80_percent_time_h": float(t[np.argmax(SOC < 0.8)] / 3600) if np.any(SOC < 0.8) else None,

                "SOC_50_percent_time_h": float(t[np.argmax(SOC < 0.5)] / 3600) if np.any(SOC < 0.5) else None,

                "SOC_20_percent_time_h": float(t[np.argmax(SOC < 0.2)] / 3600) if np.any(SOC < 0.2) else None,

                "voltage_below_3_2V_time_h": float(t[np.argmax(V_term < 3.2)] / 3600) if np.any(V_term < 3.2) else None,

                "voltage_below_3_0V_time_h": float(t[np.argmax(V_term < 3.0)] / 3600) if np.any(V_term < 3.0) else None,

            },

        }

        summary_data["scenarios"][label] = scenario_data

  

    # 添加场景对比分析

    summary_data["comparison_analysis"] = {

        "best_battery_life": max(all_results.keys(), key=lambda k: all_results[k]["summary"]["time_to_empty_h"]),

        "worst_battery_life": min(all_results.keys(), key=lambda k: all_results[k]["summary"]["time_to_empty_h"]),

        "highest_remaining_soc_at_shutdown": max(all_results.keys(), key=lambda k: all_results[k]["summary"]["final_soc_pct"]),

        "lowest_voltage_observed": min(all_results.keys(), key=lambda k: all_results[k]["summary"]["min_voltage_V"]),

        "physical_phenomena": {

            "low_temp_early_shutdown": {

                "description": "低温导致内阻增大，电池在SOC较高时因端电压过低提前关机",

                "observed_in": "Case_C",

                "remaining_soc_pct": all_results.get("Case_C", {}).get("summary", {}).get("final_soc_pct", "N/A"),

            },

            "high_load_voltage_drop": {

                "description": "高负载场景电流大，内阻压降大，导致端电压快速下降",

                "observed_in": "Case_B",

            },

            "nonlinear_soc_drop": {

                "description": "非线性OCV模型使SOC曲线末端出现加速下降特征",

                "model_feature": "ln(SOC)项捕捉低电量跳水现象",

            },

        },

    }

  

    filepath = os.path.join(output_dir, "simulation_summary_v4.json")

    with open(filepath, "w", encoding="utf-8") as f:

        json.dump(summary_data, f, ensure_ascii=False, indent=2)

  

    return filepath

  
  

def plot_single_scenario(

    result: Dict[str, Any],

    output_dir: str,

    label: str,

) -> str:

    """绘制单个场景的详细结果图 (4 子图版)。"""

    t = result["t"] / 3600.0

    SOC = result["SOC"]

    T_C = result["T"] - 273.15

    I = result["I"]

    V_term = result["V_term"]

    scenario = result["scenario"]

    summary = result["summary"]

  

    fig, axes = plt.subplots(2, 2, figsize=(14, 10))

  

    title = f"{scenario['name']}\n{scenario['description']}"

    fig.suptitle(title, fontsize=14, fontweight="bold")

  

    # ========================

    # SOC 曲线

    # ========================

    ax1 = axes[0, 0]

    ax1.plot(t, SOC * 100, "b-", linewidth=2, label="SOC")

    ax1.axhline(y=1, color="r", linestyle="--", alpha=0.7, label="截止线 (1%)")

    ax1.set_ylabel("荷电状态 SOC (%)", fontsize=11)

    ax1.set_xlabel("时间 (小时)", fontsize=11)

    ax1.set_ylim([0, 105])

    ax1.grid(True, alpha=0.3)

    ax1.legend(loc="upper right")

    ax1.set_title(f"续航: {summary['time_to_empty_h']:.2f}h | 关机原因: {summary['shutdown_reason']}", fontsize=10)

  

    # ========================

    # 端电压曲线 (V4 新增)

    # ========================

    ax2 = axes[0, 1]

    ax2.plot(t, V_term, "purple", linewidth=2, label="端电压 V_term")

    ax2.axhline(y=3.0, color="r", linestyle="--", alpha=0.7, label="截止电压 (3.0V)")

    ax2.set_ylabel("端电压 (V)", fontsize=11)

    ax2.set_xlabel("时间 (小时)", fontsize=11)

    ax2.grid(True, alpha=0.3)

    ax2.legend(loc="upper right")

    ax2.set_title(f"最低电压: {summary['min_voltage_V']:.3f}V", fontsize=10)

  

    # ========================

    # 温度曲线

    # ========================

    ax3 = axes[1, 0]

    ax3.plot(t, T_C, "r-", linewidth=2, label="电池温度")

    ax3.axhline(

        y=scenario["T_env_C"],

        color="g",

        linestyle="--",

        alpha=0.7,

        label=f"环境温度 ({scenario['T_env_C']}°C)",

    )

    ax3.set_ylabel("温度 (°C)", fontsize=11)

    ax3.set_xlabel("时间 (小时)", fontsize=11)

    ax3.grid(True, alpha=0.3)

    ax3.legend(loc="upper right")

    ax3.set_title(f"温度范围: {summary['min_temp_C']:.1f}°C ~ {summary['max_temp_C']:.1f}°C", fontsize=10)

  

    # ========================

    # 电流曲线

    # ========================

    ax4 = axes[1, 1]

    ax4.plot(t, I, "g-", linewidth=1.5, label="放电电流")

    ax4.set_ylabel("电流 (A)", fontsize=11)

    ax4.set_xlabel("时间 (小时)", fontsize=11)

    ax4.grid(True, alpha=0.3)

    ax4.legend(loc="upper right")

    ax4.set_title(f"平均电流: {summary['avg_current_A']:.3f}A", fontsize=10)

  

    plt.tight_layout()

  

    filepath = os.path.join(output_dir, f"{label}_detailed_v4.png")

    plt.savefig(filepath, dpi=150, bbox_inches="tight")

    plt.close(fig)

  

    return filepath

  
  

def plot_comparison(

    all_results: Dict[str, Dict[str, Any]],

    output_dir: str,

) -> str:

    """绘制多场景对比图 (3 子图版)。"""

    fig, axes = plt.subplots(3, 1, figsize=(14, 12), sharex=True)

  

    colors = {"Case_A": "blue", "Case_B": "red", "Case_C": "green", "Case_D": "orange"}

    linestyles = {"Case_A": "-", "Case_B": "--", "Case_C": "-.", "Case_D": ":"}

  

    for label, result in all_results.items():

        t = result["t"] / 3600.0

        SOC = result["SOC"] * 100

        T_C = result["T"] - 273.15

        V_term = result["V_term"]

        scenario = result["scenario"]

        summary = result["summary"]

  

        color = colors.get(label, "black")

        ls = linestyles.get(label, "-")

  

        # SOC 对比

        axes[0].plot(

            t, SOC,

            color=color,

            linestyle=ls,

            linewidth=2,

            label=f"{scenario['name']} ({summary['time_to_empty_h']:.1f}h)",

        )

  

        # 端电压对比

        axes[1].plot(

            t, V_term,

            color=color,

            linestyle=ls,

            linewidth=2,

            label=f"{scenario['name']} (最低{summary['min_voltage_V']:.2f}V)",

        )

  

        # 温度对比

        axes[2].plot(

            t, T_C,

            color=color,

            linestyle=ls,

            linewidth=2,

            label=f"{scenario['name']} ({summary['max_temp_C']:.1f}°C)",

        )

  

    # SOC 图设置

    axes[0].set_ylabel("荷电状态 SOC (%)", fontsize=12)

    axes[0].set_ylim([0, 105])

    axes[0].grid(True, alpha=0.3)

    axes[0].legend(loc="upper right", fontsize=9)

    axes[0].set_title("SOC 放电曲线对比", fontsize=13, fontweight="bold")

  

    # 端电压图设置

    axes[1].axhline(y=3.0, color="red", linestyle="--", alpha=0.5, linewidth=2, label="截止电压")

    axes[1].set_ylabel("端电压 (V)", fontsize=12)

    axes[1].grid(True, alpha=0.3)

    axes[1].legend(loc="upper right", fontsize=9)

    axes[1].set_title("端电压曲线对比 (关键：观察低温场景的电压跳水)", fontsize=13, fontweight="bold")

  

    # 温度图设置

    axes[2].set_ylabel("温度 (°C)", fontsize=12)

    axes[2].set_xlabel("时间 (小时)", fontsize=12)

    axes[2].grid(True, alpha=0.3)

    axes[2].legend(loc="upper right", fontsize=9)

    axes[2].set_title("电池温度曲线对比", fontsize=13, fontweight="bold")

  

    fig.suptitle(

        "智能手机电池仿真 V4 - NASA实测参数 多场景对比",

        fontsize=14,

        fontweight="bold",

        y=1.02,

    )

  

    plt.tight_layout()

  

    filepath = os.path.join(output_dir, "scenario_comparison_v4.png")

    plt.savefig(filepath, dpi=150, bbox_inches="tight")

    plt.close(fig)

  

    return filepath

  
  

def plot_ocv_comparison(output_dir: str) -> str:

    """

    绘制新旧 OCV 模型对比图。

  

    展示 V4 非线性 OCV 模型相比 V3 简单多项式的改进。

    """

    fig, axes = plt.subplots(1, 2, figsize=(14, 5))

  

    soc = np.linspace(0.01, 0.99, 200)

  

    # 旧版 V3 简单多项式

    coeffs_v3 = [0.6, -0.4, 0.87, 3.4]

    ocv_v3 = np.polyval(coeffs_v3, soc)

  

    # 新版 V4 组合模型

    p = BATTERY_CONFIG["fitted_params"]["ocv_params"]

    term_poly = p['a'] + p['b'] * soc + p['c'] * (soc ** 2) + p['d'] * (soc ** 3)

    term_log_low = p['e'] * np.log(soc)

    term_log_high = p['f'] * np.log(1 - soc)

    term_exp = p['g'] * np.exp(-30 * soc)

    ocv_v4 = term_poly + term_log_low + term_log_high + term_exp

  

    # 左图：全范围对比

    axes[0].plot(soc * 100, ocv_v3, 'b--', linewidth=2, label='V3: 3阶多项式')

    axes[0].plot(soc * 100, ocv_v4, 'r-', linewidth=2, label='V4: 组合模型 (NASA拟合)')

    axes[0].set_xlabel("SOC (%)", fontsize=12)

    axes[0].set_ylabel("开路电压 OCV (V)", fontsize=12)

    axes[0].set_title("OCV-SOC 曲线对比 (全范围)", fontsize=13)

    axes[0].legend(fontsize=10)

    axes[0].grid(True, alpha=0.3)

    axes[0].invert_xaxis()

  

    # 右图：低 SOC 区域放大

    mask = soc < 0.25

    axes[1].plot(soc[mask] * 100, ocv_v3[mask], 'b--', linewidth=2, label='V3: 3阶多项式')

    axes[1].plot(soc[mask] * 100, ocv_v4[mask], 'r-', linewidth=2, label='V4: 组合模型')

    axes[1].axhline(y=3.0, color='gray', linestyle=':', alpha=0.7, label='截止电压 3.0V')

    axes[1].set_xlabel("SOC (%)", fontsize=12)

    axes[1].set_ylabel("开路电压 OCV (V)", fontsize=12)

    axes[1].set_title("低电量区域放大 (SOC < 25%) - 关键跳水区域", fontsize=13)

    axes[1].legend(fontsize=10)

    axes[1].grid(True, alpha=0.3)

    axes[1].invert_xaxis()

  

    # 添加注释

    axes[1].annotate(

        'V4模型在低SOC时\n电压急剧下降\n(物理真实)',

        xy=(5, ocv_v4[soc < 0.06][-1]),

        xytext=(12, 3.3),

        fontsize=9,

        arrowprops=dict(arrowstyle='->', color='red'),

        color='red',

    )

  

    plt.tight_layout()

  

    filepath = os.path.join(output_dir, "ocv_model_comparison.png")

    plt.savefig(filepath, dpi=150, bbox_inches="tight")

    plt.close(fig)

  

    return filepath

  
  

def print_summary_table(all_results: Dict[str, Dict[str, Any]]) -> None:

    """在控制台打印结果摘要表格。"""

    print("\n" + "=" * 100)

    print("仿真结果摘要 (V4 - NASA实测参数版)")

    print("=" * 100)

    print(f"{'场景':<20} {'续航(h)':<10} {'最终SOC(%)':<12} {'最低电压(V)':<12} {'温度范围(°C)':<16} {'关机原因':<20}")

    print("-" * 100)

  

    for label, result in all_results.items():

        s = result["summary"]

        name = result["scenario"]["name"][:18]

        temp_range = f"{s['min_temp_C']:.0f} ~ {s['max_temp_C']:.0f}"

        print(

            f"{name:<20} "

            f"{s['time_to_empty_h']:<10.2f} "

            f"{s['final_soc_pct']:<12.1f} "

            f"{s['min_voltage_V']:<12.3f} "

            f"{temp_range:<16} "

            f"{s['shutdown_reason']:<20}"

        )

  

    print("=" * 100)

  
  

# ================================================================================

# 第六部分：主程序入口

# ================================================================================

  

if __name__ == "__main__":

    # 配置中文字体

    configure_chinese_font()

  

    # 获取输出目录

    output_dir = get_output_dir()

    print(f"结果将保存至: {output_dir}")

    print(f"\n模型版本: V4 (NASA实测参数版)")

    print(f"  - OCV 模型: 组合模型 (多项式+对数+指数)")

    print(f"  - 活化能 Ea: {BATTERY_CONFIG['physics']['Ea']/1000:.2f} kJ/mol")

    print(f"  - 参考内阻 R_ref: {BATTERY_CONFIG['fitted_params']['R_ref']*1000:.1f} mΩ @ 24°C")

  

    # 收集所有图像路径

    figure_paths = {}

  

    # ========================

    # 绘制 OCV 模型对比图

    # ========================

    print("\n正在生成 OCV 模型对比图...")

    ocv_path = plot_ocv_comparison(output_dir)

    figure_paths["ocv_model_comparison"] = {

        "path": ocv_path,

        "description": "V3 vs V4 OCV模型对比，展示非线性模型在低SOC区域的改进",

        "subplots": ["全范围对比", "低SOC区域放大 (SOC<25%)"],

    }

    print(f"  -> OCV 对比图已保存: {ocv_path}")

  

    # ========================

    # 运行多场景仿真

    # ========================

    scenarios = {

        "Case_A": "case_a",  # 办公场景

        "Case_B": "case_b",  # 游戏场景

        "Case_C": "case_c",  # 极寒场景

        "Case_D": "case_d",  # 低温轻度 (对照)

    }

  

    all_results: Dict[str, Dict[str, Any]] = {}

  

    for label, scenario_key in scenarios.items():

        print(f"\n正在仿真: {label} ({SCENARIO_PROFILES[scenario_key]['name']})...")

        result = run_simulation(scenario_key=scenario_key, seed=42)

        all_results[label] = result

  

        # 绘制单场景详细图

        fig_path = plot_single_scenario(result, output_dir, label)

        figure_paths[f"{label}_detailed"] = {

            "path": fig_path,

            "description": f"{SCENARIO_PROFILES[scenario_key]['name']} 详细仿真结果",

            "subplots": ["SOC随时间变化", "端电压随时间变化", "温度随时间变化", "电流随时间变化"],

        }

        print(f"  -> 详细图已保存: {fig_path}")

        print(f"     续航: {result['summary']['time_to_empty_h']:.2f}h, "

              f"关机原因: {result['summary']['shutdown_reason']}")

  

    # ========================

    # 绘制对比图

    # ========================

    print("\n正在生成对比图...")

    comparison_path = plot_comparison(all_results, output_dir)

    figure_paths["scenario_comparison"] = {

        "path": comparison_path,

        "description": "多场景对比图，展示不同使用条件下的电池行为差异",

        "subplots": ["SOC放电曲线对比", "端电压曲线对比", "电池温度曲线对比"],

        "key_insight": "观察Case_C(极寒)在SOC较高时因电压过低提前关机",

    }

    print(f"  -> 对比图已保存: {comparison_path}")

  

    # ========================

    # 保存结果摘要

    # ========================

    json_path = save_results_to_json(all_results, output_dir, figure_paths)

    print(f"  -> JSON 摘要已保存: {json_path}")

  

    # ========================

    # 打印摘要表格

    # ========================

    print_summary_table(all_results)

  

    print("\n仿真完成！")

    print("\n关键物理现象验证：")

    print("  1. Case C (极寒 -10°C) 应该在 SOC 仍有余量时因端电压过低而提前关机")

    print("  2. 所有场景的 SOC 曲线末端应该出现非线性'跳水'")

    print("  3. 低温场景的内阻显著增大，导致端电压下降更快")
```